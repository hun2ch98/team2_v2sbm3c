<!DOCTYPE html>

<html layout:decorate="~{layout}"> <!-- layout.html 상속-->
<div layout:fragment="content">

  <script>
    window.onload = function() {
      // <img src="/survey/images/good.png" style="width: 22px" title="추천">         
      // <img src="/survey/images/bad.png" style="width: 22px" title="비추천">   
      // 현재 로그인한 사용자의 추천 여부 반영

      let heartCnt = '[[${heartCnt}]]'; //  javascript -> Thymeleaf -> session
      let tag='';
      
      if (heartCnt == 1) {
        tag = '<a href="javascript:good([[${surveyVO.surveyno}]])"><img src="/survey/images/good.png" style="width: 22px" title="추천"></a>';
        document.querySelector('#heart_panel').innerHTML = tag; 
      } else {
        tag = '<a href="javascript:good([[${surveyVO.surveyno}]])"><img src="/survey/images/bad.png" style="width: 22px" title="비추천"></a>';
        document.querySelector('#heart_panel').innerHTML = tag; 
      }    
      
      document.querySelector('#goodcnt_panel').innerHTML = '([[${surveyVO.goodcnt}]])';
    }

    function good(surveyno) {
      console.log('-> surveyno: ' + surveyno);

      fetch("/surveyitem/good", {
          "method": "post",
          "headers": {
              "Content-Type": "application/json"
          },
          body: JSON.stringify({surveyno}) // {"surveyno":surveyno}, JSON 형식으로 전송
        })
        .then((response) => response.json()) // 응답 문자열 추출
        .then((data) => {
          console.log('-> data.isMember: ' + data.isMember);

          if (data.isMember == 1) { // 회원
            let heartCnt =data.heartCnt; //  javascript -> Thymeleaf -> session
            let tag='';
            
            if (heartCnt == 1) {
              tag = '<a href="javascript:good([[${surveyVO.surveyno}]])"><img src="/survey/images/good.png" style="width: 22px" title="추천"></a>';
              document.querySelector('#heart_panel').innerHTML = tag; 
            } else {
              tag = '<a href="javascript:good([[${surveyVO.surveyno}]])"><img src="/survey/images/bad.png" style="width: 22px" title="추천"></a>';
              document.querySelector('#heart_panel').innerHTML = tag; 
            }    
            
            document.querySelector('#goodcnt_panel').innerHTML = '(' + data.goodcnt + ')';
          
          } else { // 비회원
            alert("로그인해야 추천 할 수 있습니다.");
            location.href='/member/login_cookie_need';  

          }
        }
      );
    }
  </script>
  
  <div class="title_line">
    <span id="heart_panel"></span><span id="goodcnt_panel"></span>
    설문조사 > 
    <span th:text="${surveyVO?.topic ?: ''}" class="title_line_text"></span>
  </div>

  <aside class="aside_right">
    <a href="javascript:location.reload();">새로고침</a>
    <span class='menu_divide'>│</span> 
    <a th:href="@{|/survey/list_by_surveyno_search_paging?is_continue=${is_continue ?: ''}|}">설문조사 목록</a>
  </aside>

  <div class="menu_line"></div>
  
  <!-- 회원 모드 -->
  <div>
    <form method="post" action="/surveyitem/finish">
      <input type="hidden" name="itemno" th:value="${itemno}" />
      <table class="table table-hover" style="width: 100%;">
        <colgroup>
          <col style='width: 10%;'/>
          <col style='width: 90%;'/>
        </colgroup>
        <thead>
          <tr>
            <th class="th_bs">선택</th>
            <th class="th_bs">설문 조사 항목</th>
          </tr>
        </thead>
        <tbody>
          <tr th:if="${list_m == null or #lists.isEmpty(list_m)}">
            <td colspan="3">등록된 항목이 없습니다.</td>
          </tr>
          <tr th:each="itemVO : ${list_m}" >
            <td align="center" valign="middle">
              <input type="radio" id="itemno_${itemVO.itemno}" name="itemno" th:value="${itemVO.itemno}" required />
            </td>
            <td class="td_bs" th:text="${itemVO.item}"></td>
          </tr>
        </tbody>
      </table>
      <div style="text-align: center; margin-top: 15px;">
        <!-- 참여 버튼 -->
        <button type="submit" class="btn btn-primary" style="margin-right: 10px;">참여</button>

        <!-- 결과 버튼 -->
        <a th:href="@{/surveyitem/result(surveyno=${surveyno})}" class="btn btn-secondary">결과</a>
      </div>

      <!--
      <div style="text-align: center; margin-top: 15px;">
        <button type="submit" class="btn btn-primary">결과 차트</button>
      </div>
      -->
    </form>
  </div>
  
</div>
</html>

