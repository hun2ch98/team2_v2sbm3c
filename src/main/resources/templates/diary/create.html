<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content">
  <div class="title_line">
    일기 쓰기
  </div>

  <aside class="aside_right">
    <a href="javascript:location.reload();">새로고침</a>
    <span class='menu_divide'>│</span>
    <a th:href="@{/diary/list_by_diaryno_search_paging}">목록</a>
  </aside>

  <div class="menu_line"></div>

  <form name="frm" method="post" th:object="${diaryVO}" action="./create" enctype="multipart/form-data">
    <!-- 제목 -->
    <div style="margin-bottom:10px;">
      <label>제목</label>
      <input type="text" name="title" th:value="*{title}" required="required" class="form-control" style="width: 100%;" placeholder="오늘의 제목">
    </div>

    <!-- 날짜 -->
    <div style="margin-bottom:10px;">
      <label>날짜</label>
      <input type="date" name="ddate" th:value="*{ddate}" required="required" class="form-control" style="width: 100%;">
    </div>

    <!-- 날씨 코드 드롭다운 -->
    <div style="position: relative; display: inline-block; margin-bottom: 20px;">
      <label for="weather-dropdown">날씨 코드</label>
      <button type="button" id="weather-dropdown-toggle" style="width: 300px; height: 30px; border: 1px solid #ccc; border-radius: 5px; background: #fff; text-align: left; padding: 5px;">
        선택하세요
      </button>
      <div id="weather-dropdown-menu" style="display: none; position: absolute; top: 40px; left: 0; background: #fff; border: 1px solid #ccc; border-radius: 5px; width: 300px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000;">
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 10px;">
          <div th:each="weatherCode : ${#numbers.sequence(1, 20)}" style="text-align: center;">
            <input type="radio" name="weatherno" th:value="${weatherCode}" th:id="'weather-' + ${weatherCode}" style="display: none;">
            <label th:for="'weather-' + ${weatherCode}" style="cursor: pointer; display: block;">
              <img th:src="@{'/weather/images/weather-' + ${weatherCode} + '.png'}" alt="Weather ${weatherCode}" style="width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 5px;">
            </label>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      // 날씨 드롭다운 토글 버튼 동작
      const weatherToggleButton = document.getElementById('weather-dropdown-toggle');
      const weatherDropdownMenu = document.getElementById('weather-dropdown-menu');
      weatherToggleButton.addEventListener('click', (event) => {
        event.stopPropagation();
        const isMenuVisible = weatherDropdownMenu.style.display === 'block';
        weatherDropdownMenu.style.display = isMenuVisible ? 'none' : 'block';
      });
      document.addEventListener('click', (event) => {
        if (!weatherDropdownMenu.contains(event.target)) {
          weatherDropdownMenu.style.display = 'none';
        }
      });
      weatherDropdownMenu.addEventListener('click', (event) => {
        if (event.target.tagName === 'IMG') {
          const selectedValue = event.target.parentElement.previousElementSibling.value;
          weatherToggleButton.textContent = `선택된 날씨: ${selectedValue}`;
          weatherDropdownMenu.style.display = 'none';
        }
      });
    </script>

    <!-- 감정 코드 드롭다운 -->
    <div style="position: relative; display: inline-block; margin-bottom: 20px;">
      <label for="emotion-dropdown">감정 코드</label>
      <button type="button" id="emotion-dropdown-toggle" style="width: 300px; height: 30px; border: 1px solid #ccc; border-radius: 5px; background: #fff; text-align: left; padding: 5px;">
        선택하세요
      </button>
      <div id="emotion-dropdown-menu" style="display: none; position: absolute; top: 40px; left: 0; background: #fff; border: 1px solid #ccc; border-radius: 5px; width: 300px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index: 1000;">
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 10px;">
          <div th:each="emotionCode : ${#numbers.sequence(1, 24)}" style="text-align: center;">
            <input type="radio" name="emono" th:value="${emotionCode}" th:id="'emotion-' + ${emotionCode}" style="display: none;">
            <label th:for="'emotion-' + ${emotionCode}" style="cursor: pointer; display: block;">
              <img th:src="@{'/emotion/images/image' + ${emotionCode} + '.png'}" alt="Emotion ${emotionCode}" style="width: 40px; height: 40px; border: 1px solid #ddd; border-radius: 5px;">
            </label>
          </div>
        </div>
      </div>
    </div>
    
    
    <script>
       // 감정 드롭다운 토글 버튼 동작
      const emotionToggleButton = document.getElementById('emotion-dropdown-toggle');
      const emotionDropdownMenu = document.getElementById('emotion-dropdown-menu');
      emotionToggleButton.addEventListener('click', (event) => {
        event.stopPropagation();
        const isMenuVisible = emotionDropdownMenu.style.display === 'block';
        emotionDropdownMenu.style.display = isMenuVisible ? 'none' : 'block';
      });
      document.addEventListener('click', (event) => {
        if (!emotionDropdownMenu.contains(event.target)) {
          emotionDropdownMenu.style.display = 'none';
        }
      });
      emotionDropdownMenu.addEventListener('click', (event) => {
        if (event.target.tagName === 'IMG') {
          const selectedValue = event.target.parentElement.previousElementSibling.value;
          emotionToggleButton.textContent = `선택된 감정: ${selectedValue}`;
          emotionDropdownMenu.style.display = 'none';
        }
      });
    </script>

    <!-- 내용 -->
    <div>
      <label>내용</label>
      <textarea name="summary" th:value="*{summary}" required="required" class="form-control" rows="12" style="width: 100%; position: relative; z-index: 1;">
        오늘의 날씨는 그리 맑지 않지만 오랜만에 외출을 준비합니다.
      </textarea>
    </div>

    <!-- 등록 버튼 -->
    <div class="content_body_bottom" style="margin-top: 20px;">
      <button type="submit" class="btn btn-secondary btn-sm">등록</button>
      <button type="button" onclick="location.href='./list_by_diaryno_search_paging'" class="btn btn-secondary btn-sm">목록</button>
    </div>
  </form>
</div>

<script>
  document.querySelector('form[name="frm"]').addEventListener('submit', async (event) => {
    event.preventDefault(); // 기본 폼 제출 방지

    // 폼 데이터 가져오기
    const formData = new FormData(event.target);
    const title = formData.get('title');
    const date = formData.get('ddate');
    const weatherCode = formData.get('weatherno');
    const emotionCode = formData.get('emono');
    const content = formData.get('summary');

    if (!title || !date || !weatherCode || !emotionCode || !content) {
      alert("모든 필드를 채워주세요!");
      return;
    }

    // API 요청 데이터 구성
    const payload = {
      title: title,
      weatherCode: weatherCode,
      emotionCode: emotionCode,
      content: content
    };

    try {
      // Flask API 호출
      const response = await fetch('http://127.0.0.1:5000/generate_image', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (response.ok) {
        // 이미지 URL 반환 성공
        alert(`이미지 생성 성공! URL: ${result.image_url}`);

        // 이미지 미리보기 추가
        const imagePreview = document.createElement('img');
        imagePreview.src = result.image_url;
        imagePreview.alt = '생성된 이미지';
        imagePreview.style = 'margin-top: 20px; width: 300px; height: auto; border: 1px solid #ccc; display: block;';
        document.querySelector('form[name="frm"]').appendChild(imagePreview);
      } else {
        alert(`이미지 생성 실패: ${result.error}`);
      }
    } catch (error) {
      console.error('API 호출 중 오류 발생:', error);
      alert('이미지 생성 중 문제가 발생했습니다.');
    }
  });
</script>


 
</html>
