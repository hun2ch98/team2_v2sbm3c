<html layout:decorate="~{layout}">
<div layout:fragment="content">

    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        table {
            width: 80%;
            margin: 0 auto;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 2px;
            text-align: center;
            height: 100px;
            vertical-align: top;
            word-wrap: break-word;
            width: 15%;
        }
        th {
            background-color: #f4f4f4;
            height: 20px;
        }
        td div {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            height: 100%;
        }
        .weekend {
            color: red;
        }
        .saturday {
            color: blue;
        }
    </style>

    <script>
        async function fetchIllustrationForDate(date_calendar) {
            try {
                const response = await fetch(`/diary/list_calendar_day?ddate=${date_calendar}`, {
                    method: "GET"
                });
                if (!response.ok) {
                    throw new Error(`Failed to fetch data for ${date_calendar}`);
                }
                const data = await response.json();
                // Get the smallest illustno entry for the date
                if (data && data.length > 0) {
                    data.sort((a, b) => a.illustno - b.illustno);
                    return data[0];
                }
                return null;
            } catch (error) {
                console.error("Error fetching illustration:", error);
                return null;
            }
        }

        async function generateCalendar(year, month) {
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            const calendarBody = document.querySelector("tbody");
            calendarBody.innerHTML = "";

            let row = document.createElement("tr");
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement("td");
                row.appendChild(emptyCell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement("td");

                const contentDiv = document.createElement("div");
                contentDiv.style.display = "flex";
                contentDiv.style.flexDirection = "column";
                contentDiv.style.justifyContent = "flex-start";
                contentDiv.style.height = "100%";

                const fullDateSpan = document.createElement("span");
                const date_calendar = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                fullDateSpan.textContent = date_calendar;
                contentDiv.appendChild(fullDateSpan);

                // Fetch and display illustration
                const illustrationData = await fetchIllustrationForDate(date_calendar);
                if (illustrationData) {
                    const thumbImg = document.createElement("img");
                    thumbImg.src = `/uploads/${illustrationData.illust_thumb}`;
                    thumbImg.alt = "Illustration Thumbnail";
                    thumbImg.style.maxWidth = "80%";
                    thumbImg.style.height = "auto";
                    contentDiv.appendChild(thumbImg);
                }

                cell.appendChild(contentDiv);

                if ((firstDay + day - 1) % 7 === 0) {
                    cell.classList.add("weekend");
                } else if ((firstDay + day - 1) % 7 === 6) {
                    cell.classList.add("saturday");
                }
                row.appendChild(cell);

                if ((firstDay + day) % 7 === 0) {
                    calendarBody.appendChild(row);
                    row = document.createElement("tr");
                }
            }

            if (row.children.length > 0 && row.children.length < 7) {
                while (row.children.length < 7) {
                    const emptyCell = document.createElement("td");
                    row.appendChild(emptyCell);
                }
                calendarBody.appendChild(row);
            }
        }

        window.onload = async function () {
            const year = parseInt('[[${year}]]');
            const month = parseInt('[[${month}]]') - 1; // JavaScript months are 0-based
            document.getElementById('panel_year_month').textContent = `${year}년 ${month + 1}월`;
            await generateCalendar(year, month);
        };

        function changeMonth(offset) {
            const monthTitle = document.getElementById('month_title');
            let currentYear = parseInt(monthTitle.getAttribute('data-current_year'), 10);
            let currentMonth = parseInt(monthTitle.getAttribute('data-current_month'), 10);

            currentMonth += offset;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }

            const url = `/diary/list_calendar?year=${currentYear}&month=${currentMonth + 1}`;
            location.href = url;
        }
    </script>

    <h4 id="month_title" data-current_year="[[${year}]]" data-current_month="[[${month} - 1]]">
        <a href="#" onclick="changeMonth(-1)">[이전 달]</a>
        <span id="panel_year_month"></span>
        <a href="#" onclick="changeMonth(1)">[다음 달]</a>
    </h4>
    <table>
        <thead>
            <tr>
                <th class="weekend">일요일</th>
                <th>월요일</th>
                <th>화요일</th>
                <th>수요일</th>
                <th>목요일</th>
                <th>금요일</th>
                <th class="saturday">토요일</th>
            </tr>
        </thead>
        <tbody>
            <!-- Calendar rows will be dynamically generated here -->
        </tbody>
    </table>

</div>
</html>
